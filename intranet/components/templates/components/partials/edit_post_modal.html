<!-- Edit Post Modal Content -->
<div class="modal-header">
    <h5 class="modal-title">Edit {{ post.type|title }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <form id="edit-post-form" 
          hx-post="{% url 'components:edit_post' post.id %}"
          hx-target="#post-{{ post.id }}"
          hx-swap="outerHTML"
          hx-indicator="#edit-form-spinner">
        {% csrf_token %}
        
        <!-- Title field -->
        <div class="mb-3">
            <label for="edit_title" class="form-label">{{ post.type|title }} Title</label>
            <input type="text" 
                   class="form-control" 
                   id="edit_title" 
                   name="title" 
                   value="{{ post.title|default:'' }}"
                   required>
        </div>

        <!-- Department Selection -->
        <div class="mb-3">
            <label for="edit_subdepartment" class="form-label">Department</label>
            <select class="form-select" id="edit_subdepartment" name="subdepartment">
                <option value="global" {% if post.subdepartment == 'global' %}selected{% endif %}>Global</option>
                {% for dept in subdepartments %}
                    <option value="{{ dept.id }}" 
                            {% if post.subdepartment == dept.id %}selected{% endif %}>
                        {{ dept.title }}
                    </option>
                {% endfor %}
            </select>
        </div>

        {% if post.type != 'poll' %}
            <!-- Body field for non-poll posts -->
            <div class="mb-3">
                <label for="edit_body" class="form-label">Content</label>
                <div id="edit_quill_editor"></div>
                <input type="hidden" id="edit_body" name="body" value="{{ post.body|safe }}">
            </div>
        {% else %}
            <!-- Poll End Time -->
            <div class="mb-3">
                <label for="edit_poll_end_time" class="form-label">Poll End Time (IST)</label>
                <input type="datetime-local" 
                       class="form-control" 
                       id="edit_poll_end_time" 
                       name="poll_end_time" 
                       value="{{ post.poll_end_time|date:'Y-m-d\TH:i' }}"
                       min="{% now 'Y-m-d\TH:i' %}"
                       required>
            </div>

            <!-- Poll Options -->
            <div class="mb-3" id="edit_poll_options">
                <label class="form-label">Poll Options</label>
                <div id="edit_poll_options_container">
                    {% for option in post.poll_options %}
                        <div class="input-group mb-2">
                            <input type="text" 
                                   class="form-control" 
                                   name="poll_options[]" 
                                   value="{{ option }}"
                                   required>
                            {% if not forloop.first %}
                                <button type="button" 
                                        class="btn btn-outline-danger"
                                        onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" 
                        class="btn btn-outline-primary btn-sm mt-2"
                        onclick="addEditPollOption()">
                    <i class="fas fa-plus"></i> Add Option
                </button>
            </div>
        {% endif %}

        <div class="modal-footer">
            <div id="edit-form-spinner" class="spinner-border text-primary htmx-indicator" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
    </form>
</div>

<script>
let editQuill = null;

{% if post.type != 'poll' %}
function initializeQuill() {
    console.log('Starting Quill initialization...', {
        postType: '{{ post.type }}',
        postId: '{{ post.id }}',
        postBody: `{{ post.body|safe|escapejs }}`
    });
    
    if (editQuill) {
        console.log('Destroying existing Quill instance');
        editQuill = null;
    }
    
    // Initialize Quill editor for the edit form
    editQuill = new Quill('#edit_quill_editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                ['image', 'code-block']
            ]
        },
        placeholder: 'Enter your content here...'
    });

    // Set initial content
    const initialContent = document.getElementById('edit_body').value;
    console.log('Setting initial content:', {
        rawContent: initialContent,
        contentLength: initialContent.length
    });
    
    // Ensure the editor container is visible
    const editorContainer = document.querySelector('#edit_quill_editor');
    if (editorContainer) {
        editorContainer.style.display = 'block';
        editorContainer.style.minHeight = '200px';
    }

    // Set content with a small delay to ensure editor is ready
    setTimeout(() => {
        editQuill.root.innerHTML = initialContent;
        console.log('Content set in editor:', {
            editorContent: editQuill.root.innerHTML,
            hiddenInputContent: document.getElementById('edit_body').value
        });
    }, 100);

    // Watch for content changes
    editQuill.on('text-change', function() {
        const content = editQuill.root.innerHTML;
        document.getElementById('edit_body').value = content;
        console.log('Content updated:', {
            newContent: content,
            length: content.length
        });
    });
}

// Initialize Quill after modal content is loaded
document.addEventListener('htmx:afterSwap', function(evt) {
    console.log('HTMX afterSwap event:', {
        targetId: evt.detail.target.id,
        target: evt.detail.target
    });
    
    if (evt.detail.target.id === 'editPostModalContent') {
        console.log('Initializing Quill after modal content load');
        // Add a small delay to ensure DOM is ready
        setTimeout(initializeQuill, 100);
    }
});

// Handle form submission
document.body.addEventListener('htmx:configRequest', function(evt) {
    if (evt.detail.elt.id === 'edit-post-form' && editQuill) {
        const content = editQuill.root.innerHTML;
        evt.detail.parameters['body'] = content;
        
        console.log('Submitting form:', {
            title: evt.detail.parameters.title,
            subdepartment: evt.detail.parameters.subdepartment,
            body: content,
            type: '{{ post.type }}',
            bodyLength: content.length
        });
    }
});

// Clean up Quill instance when modal is closed
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful && evt.detail.elt.id === 'edit-post-form') {
        console.log('Form submission successful, cleaning up');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editPostModal'));
        if (modal) {
            modal.hide();
            editQuill = null;
        }
    }
});

// Add modal event listeners
document.addEventListener('show.bs.modal', function (event) {
    console.log('Modal showing');
    const modal = event.target;
    modal.removeAttribute('aria-hidden');
    modal.setAttribute('aria-modal', 'true');
});

document.addEventListener('hide.bs.modal', function (event) {
    console.log('Modal hiding, cleaning up');
    if (editQuill) {
        editQuill = null;
    }
});
{% endif %}

function addEditPollOption() {
    const container = document.getElementById('edit_poll_options_container');
    const newOption = document.createElement('div');
    newOption.className = 'input-group mb-2';
    newOption.innerHTML = `
        <input type="text" 
               class="form-control" 
               name="poll_options[]" 
               required>
        <button type="button" 
                class="btn btn-outline-danger"
                onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(newOption);
}
</script> 