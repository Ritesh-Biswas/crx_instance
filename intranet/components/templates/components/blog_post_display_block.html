{% if value.display_snippet.show_blogpost %}
<!-- Include Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- Add CSRF token meta tag -->
{% csrf_token %}

<div class="row mt-4">
    <div class="col-12">
        <div class="bg-white p-4 border rounded-lg rounded">
            <div class="d-flex align-items-center mb-3">
                <h2 class="h2 fw-bold me-auto">Latest Posts</h2>
                <div class="d-flex gap-3">
                    <div>
                        <label for="post_type_filter" class="form-label text-secondary small mb-1">Filter by Type</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M2 2a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V2zm1 0v12h10V2H3z"/>
                                    <path d="M4 5h8v1H4V5zm0 2h8v1H4V7zm0 2h8v1H4V9zm0 2h4v1H4v-1z"/>
                                </svg>
                            </span>
                            <select id="post_type_filter" 
                                    name="post_type_filter" 
                                    class="form-select"
                                    hx-get="{% url 'components:load_more_posts' %}"
                                    hx-target="#blog-post-list"
                                    hx-trigger="change"
                                    hx-include="#department_filter"
                                    hx-indicator="#loading-spinner">
                                <option value="all">View all</option>
                                <option value="post">Posts only</option>
                                <option value="question">Questions only</option>
                                <option value="poll">Poll only</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="department_filter" class="form-label text-secondary small mb-1">Filter by Department</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 9.5A1.5 1.5 0 0 1 2.5 8h3A1.5 1.5 0 0 1 7 9.5v3A1.5 1.5 0 0 1 5.5 14h-3A1.5 1.5 0 0 1 1 12.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 8h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 12.5v-3z"/>
                                </svg>
                            </span>
                            <select id="department_filter" 
                                    name="department_filter" 
                                    class="form-select"
                                    hx-get="{% url 'components:load_more_posts' %}"
                                    hx-target="#blog-post-list"
                                    hx-trigger="change"
                                    hx-include="#post_type_filter"
                                    hx-indicator="#loading-spinner">
                                <option value="all">View all</option>
                                <!-- Department options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <ul id="blog-post-list" class="list-unstyled"
                hx-get="{% url 'components:load_more_posts' %}"
                hx-trigger="revealed"
                hx-swap="beforeend"
                hx-include="#post_type_filter, #department_filter"
                hx-indicator="#loading-spinner">
                {% include "components/partials/post_list.html" with posts=initial_posts %}
            </ul>
            <div id="loading-spinner" class="text-center my-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Post Modal -->
<div class="modal fade" id="editPostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Content will be loaded via HTMX -->
        </div>
    </div>
</div>

{% endif %}

<!-- Include HTMX -->
<script src="https://unpkg.com/htmx.org@2.0.6"></script>

<script>
// Add CSRF token to all HTMX requests
document.body.addEventListener('htmx:configRequest', function(evt) {
    evt.detail.headers['X-CSRFToken'] = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
});

// Function to format time in local 24-hour format
function formatLocalTime(timestamp) {
    if (!timestamp) return '';
    
    try {
        // Check if the timestamp is in ET (-04:00)
        if (timestamp.includes('-04:00')) {
            // Extract time directly from the timestamp string
            const matches = timestamp.match(/T(\d{2}):(\d{2})/);
            if (matches) {
                const [_, hours, minutes] = matches;
                // Format with leading zeros
                return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
            }
            return '';
        } else {
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return '';
            }
            
            // For UTC timestamps, subtract 4 hours to get back to ET time
            const etHours = date.getUTCHours() - 4;  // Convert UTC to ET
            const minutes = date.getUTCMinutes();
            
            // Create a new date with ET hours
            const today = new Date();
            const etTime = new Date(
                today.getFullYear(),
                today.getMonth(),
                today.getDate(),
                etHours,
                minutes
            );
            
            return etTime.toLocaleString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
    } catch (error) {
        console.error('Error formatting time:', error);
        return '';
    }
}

// Update timestamps after content is loaded
function updateTimestamps() {
    document.querySelectorAll('.local-time').forEach(element => {
        const timestamp = element.dataset.timestamp;
        if (timestamp) {
            element.textContent = formatLocalTime(timestamp);
        }
    });

    document.querySelectorAll('.poll-end-time').forEach(element => {
        const timestamp = element.dataset.timestamp;
        if (timestamp) {
            const formattedTime = formatLocalTime(timestamp);
            element.textContent = `Ends at ${formattedTime}`;
        }
    });
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    updateTimestamps();
});

// HTMX event handlers
document.body.addEventListener('htmx:afterSwap', function(evt) {
    setTimeout(updateTimestamps, 100);
});

document.body.addEventListener('htmx:afterSettle', function(evt) {
    setTimeout(updateTimestamps, 200);
});

// Handle HTMX errors
document.body.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX Error:', evt.detail);
});

// Keep existing JavaScript for department loading
document.addEventListener('DOMContentLoaded', function() {
    const departmentDropdown = document.getElementById('department_filter');
    
    fetch('/components/subdepartments/')
        .then(response => response.json())
        .then(data => {
            data.subdepartments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                departmentDropdown.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading departments:', error));
});
</script>